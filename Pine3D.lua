local a=(...):match("(.-)[^%.]+$")local b=require(a.."betterblittle")local c=math.min;local d=math.max;local e=math.floor;local f=math.ceil;local function g(h,i,j,k)local l={width=j*2,height=k*3,colorValues={},depthValues={},blitWin=window.create(term.current(),h,i,j,k,false),backgroundColor=colors.lightBlue}function l:setSize(h,i,j,k)self.width=j*2;self.height=k*3;self.blitWin.reposition(h,i,j,k)self:clear()end;function l:clear()self.colorValues={}self.depthValues={}local colors=self.colorValues;local m=self.depthValues;local n=math.huge;local o=self.width;local p=self.backgroundColor;for i=1,self.height do colors[i]={}m[i]={}local q=colors[i]local r=m[i]for h=1,o do q[h]=p;r[h]=n end end end;function l:clearDepth()local m=self.depthValues;local n=-math.huge;local o=self.width;for i=1,self.height do local r=m[i]for h=1,o do r[h]=n end end end;function l:fastClear()local s=self.backgroundColor;local colors=self.colorValues;local o=self.width;for i=1,self.height do local q=colors[i]for h=1,o do q[h]=s end end end;function l:setPixel(h,i,t)h=e(h+0.5)i=e(i+0.5)if h>=1 and h<=self.width then if i>=1 and i<=self.height then self.colorValues[i][h]=t end end end;function l:image(h,i,u)local o=self.width;local colors=self.colorValues;for v,w in pairs(u)do local x=v+i;local q=colors[x]if q then for y,z in pairs(w)do if z and z>0 then local A=y+h;if A>=1 and A<=o then q[A]=z end end end end end end;function l:drawLineNoInterp(B,C,D,E,t,F)local colors=self.colorValues;local m=self.depthValues;local G=self.width;local H=self.height;local I=D-B;local J=E-C;if I~=0 then for h=d(f(c(B,D)),1),c(e(d(B,D)),G)do local K=(h-B)/I;local i=e(C+K*J+0.5)if i>0 and i<=H and F>=m[i][h]then colors[i][h]=t;m[i][h]=F end end end;if J~=0 then for i=d(f(c(C,E)),1),c(e(d(C,E)),H)do local L=(i-C)/J;local h=e(B+L*I+0.5)if h>0 and h<=G and F>=m[i][h]then colors[i][h]=t;m[i][h]=F end end end end;function l:drawLineInterp(B,C,D,E,t,M,N)local colors=self.colorValues;local m=self.depthValues;local G=self.width;local H=self.height;B=B+0.5;D=D+0.5;C=C-0.5;E=E-0.5;local I=D-B;local J=E-C;local O=N-M;if I~=0 then for h=d(f(c(B,D)),1),c(e(d(B,D)),G)do local K=(h-B)/I;local i=e(C+K*J+0.5)local P=M+K*O;if i>0 and i<=H and P>=m[i][h]then colors[i][h]=t;m[i][h]=P end end end;if J~=0 then for i=d(f(c(C,E)),1),c(e(d(C,E)),H)do local L=(i-C)/J;local h=e(B+L*I+0.5)local P=M+L*O;if h>0 and h<=G and P>=m[i][h]then colors[i][h]=t;m[i][h]=P end end end end;local Q=colors.black;function l:drawTriangleNoInterp(B,C,D,E,R,S,t,T,U)if B<0 and D<0 and R<0 or C<1 and E<1 and S<1 then return end;local G=self.width;if B>G and D>G and R>G then return end;local H=self.height;if C>H and E>H and S>H then return end;if C>E then C,E=E,C;B,D=D,B end;if E>S then S,E=E,S;R,D=D,R end;if C>E then C,E=E,C;B,D=D,B end;local e,f=e,f;local c,d=c,d;local V=c(d(1,f(C)),H)local W=c(d(0,e(E)),H)local X=c(d(1,e(S)),H)local colors=self.colorValues;local m=self.depthValues;local F=1/U;if C~=E and C~=S then local Y=(D-B)/(E-C)local Z=(R-B)/(S-C)for i=V,W do local J=i-C;local _=B+J*Y;local a0=B+J*Z;if a0<_ then _,a0=a0,_ end;local a1=e(_+0.5)local a2=e(a0+0.5)if a1<1 then a1=1 end;if a2>G then a2=G end;local q=colors[i]local r=m[i]for h=a1,a2 do if F>r[h]then r[h]=F;q[h]=t end end end end;if S~=E and C~=S then local Y=(D-R)/(E-S)local Z=(B-R)/(C-S)for i=W+1,X do local J=i-S;local _=R+J*Y;local a0=R+J*Z;if a0<_ then _,a0=a0,_ end;local a1=e(_+0.5)local a2=e(a0+0.5)if a1<1 then a1=1 end;if a2>G then a2=G end;local q=colors[i]local r=m[i]for h=a1,a2 do if F>r[h]then r[h]=F;q[h]=t end end end end;local T=T;if T or self.triangleEdges then local a3=self.drawLineNoInterp;local t=T or Q;a3(self,B,C,D,E,t,F)a3(self,D,E,R,S,t,F)a3(self,R,S,B,C,t,F)end end;function l:drawTriangleInterp(B,C,D,E,R,S,t,T,a4,a5,a6,a7)if B<0 and D<0 and R<0 or C<1 and E<1 and S<1 then return end;local G=self.width;if B>G and D>G and R>G then return end;local H=self.height;if C>H and E>H and S>H then return end;if C>E then C,E=E,C;B,D=D,B;a5,a6=a6,a5 end;if E>S then S,E=E,S;R,D=D,R;a7,a6=a6,a7 end;if C>E then C,E=E,C;B,D=D,B;a5,a6=a6,a5 end;local e,f=e,f;local c,d=c,d;local V=c(d(1,f(C)),H)local W=c(d(0,e(E)),H)local X=c(d(1,e(S)),H)local colors=self.colorValues;local m=self.depthValues;local a8=1/a7;local N=1/a6;local M=1/a5;if C~=E and C~=S then local a9=E-C;local aa=S-C;local Y=(D-B)/a9;local Z=(R-B)/aa;local ab=N-M;local ac=a8-M;for i=V,W do local J=i-C;local _=B+J*Y;local a0=B+J*Z;local ad=J/a9;local ae=J/aa;local af=M+ad*ab;local ag=M+ae*ac;if a0<_ then _,a0=a0,_;af,ag=ag,af end;local a1=e(_+1.5)local a2=e(a0+0.5)if a1<1 then a1=1 end;if a2>G then a2=G end;_=e(_+0.5)a0=e(a0+1.5)local ah=a0-_;local q=colors[i]local r=m[i]local ai=ag-af;for h=a1,a2 do local K=(h-_)/ah;local P=af+K*ai;if P>r[h]then r[h]=P;q[h]=t end end end end;if S~=E and C~=S then local aj=E-S;local ak=C-S;local Y=(D-R)/aj;local Z=(B-R)/ak;local ab=N-a8;local ac=M-a8;for i=W+1,X do local J=i-S;local _=R+J*Y;local a0=R+J*Z;local ad=J/aj;local ae=J/ak;local af=a8+ad*ab;local ag=a8+ae*ac;if a0<_ then _,a0=a0,_;af,ag=ag,af end;local a1=e(_+1.5)local a2=e(a0+0.5)if a1<1 then a1=1 end;if a2>G then a2=G end;_=e(_+0.5)a0=e(a0+1.5)local ah=a0-_;local q=colors[i]local r=m[i]local ai=ag-af;for h=a1,a2 do local K=(h-_)/ah;local P=af+K*ai;if P>r[h]then r[h]=P;q[h]=t end end end end;local T=T;if T or self.triangleEdges then local a3=self.drawLineInterp;local t=T or Q;a3(self,B,C,D,E,t,M,N)a3(self,D,E,R,S,t,N,a8)a3(self,R,S,B,C,t,a8,M)end end;function l:drawBuffer()local al=self.blitWin;b.drawBuffer(self.colorValues,al)al.setVisible(true)al.setVisible(false)end;function l:depthInterpolation(am)self.drawTriangle=am and self.drawTriangleInterp or self.drawTriangleNoInterp;self:clear()end;function l:useTriangleEdges(am)self.triangleEdges=am end;l:depthInterpolation(true)return l end;local function an(ao,ap,aq,ar,as)local at=as[1]local au=as[2]local av=as[3]local aw=ap and ap-at or 0;local ax=aq and aq-au or 0;local ay=ar and ar-av or 0;for az=1,#ao do local aA=ao[az]local aB=aw+(aA[1]+aA[4]+aA[7])/3;local aC=ax+(aA[2]+aA[5]+aA[8])/3;local aD=ay+(aA[3]+aA[6]+aA[9])/3;aA[16]=aB*aB+aC*aC+aD*aD end end;local aE=math.rad;local aF=math.sin;local aG=math.cos;local function aH(h,i,aI,aJ,aK)local a6=aK*aI-aJ*i;local i=aJ*aI+aK*i;local aI=a6;return h,i,aI end;local function aL(h,i,aI,aJ,aK)local a6=aK*aI-aJ*h;local h=aJ*aI+aK*h;local aI=a6;return h,i,aI end;local function aM(h,i,aI,aJ,aK)local E=aK*i-aJ*h;local h=aJ*i+aK*h;local i=E;return h,i end;local function aN(aO,aP,aQ,aR)local aS,aT=0,1;local aU,aV=0,1;local aW,aX=0,1;if aP==0 then aP=nil end;if aP then aS,aT=aF(aP),aG(aP)end;if aQ==0 then aQ=nil end;if aQ then aU,aV=aF(aQ),aG(aQ)end;if aR==0 then aR=nil end;if aR then aW,aX=aF(aR),aG(aR)end;local aY={}for aZ,aA in pairs(aO)do local B,C,a5=aA[1],aA[2],aA[3]local D,E,a6=aA[4],aA[5],aA[6]local R,S,a7=aA[7],aA[8],aA[9]if aQ then B,C,a5=aL(B,C,a5,aU,aV)D,E,a6=aL(D,E,a6,aU,aV)R,S,a7=aL(R,S,a7,aU,aV)end;if aR then B,C=aM(B,C,a5,aW,aX)D,E=aM(D,E,a6,aW,aX)R,S=aM(R,S,a7,aW,aX)end;if aP then B,C,a5=aH(B,C,a5,aS,aT)D,E,a6=aH(D,E,a6,aS,aT)R,S,a7=aH(R,S,a7,aS,aT)end;aY[#aY+1]={B,C,a5,D,E,a6,R,S,a7}aY[#aY][10]=aA[10]aY[#aY][11]=aA[11]aY[#aY][12]=aA[12]end;return aY end;local a_={}function a_.invertTriangles(aO)if not aO or type(aO)~="table"then error("transforms.invertTriangles expected arg#1 to be a table (model)")end;for az=1,#aO do local b0=aO[az]aO[az]={x1=b0.x1,y1=b0.y1,z1=b0.z1,x2=b0.x3,y2=b0.y3,z2=b0.z3,x3=b0.x2,y3=b0.y2,z3=b0.z2,c=b0.c,forceRender=b0.forceRender,outlineColor=b0.outlineColor}end;return aO end;function a_.setOutline(aO,b1)if not aO or type(aO)~="table"then error("transforms.invertTriangles expected arg#1 to be a table (model)")end;for az=1,#aO do local b0=aO[az]if type(b1)=="table"then b0.outlineColor=b1[b0.c]or b0.outlineColor else b0.outlineColor=b1 end end;return aO end;function a_.mapColor(aO,b1)if not aO or type(aO)~="table"then error("transforms.mapColor expected arg#1 to be a table (model)")end;for az=1,#aO do local b0=aO[az]if type(b1)=="table"then b0.c=b1[b0.c]or b0.c else b0.c=b1 end end;return aO end;function a_.center(aO)local b2,b3=math.huge,-math.huge;local V,X=math.huge,-math.huge;local b4,b5=math.huge,-math.huge;for az=1,#aO do local b6=aO[az]b2,b3=c(b2,b6.x1),d(b3,b6.x1)b2,b3=c(b2,b6.x2),d(b3,b6.x2)b2,b3=c(b2,b6.x3),d(b3,b6.x3)V,X=c(V,b6.y1),d(X,b6.y1)V,X=c(V,b6.y2),d(X,b6.y2)V,X=c(V,b6.y3),d(X,b6.y3)b4,b5=c(b4,b6.z1),d(b5,b6.z1)b4,b5=c(b4,b6.z2),d(b5,b6.z2)b4,b5=c(b4,b6.z3),d(b5,b6.z3)end;local b7=-(b3+b2)*0.5;local b8=-(X+V)*0.5;local b9=-(b5+b4)*0.5;for az=1,#aO do local b6=aO[az]b6.x1=b6.x1+b7;b6.x2=b6.x2+b7;b6.x3=b6.x3+b7;b6.y1=b6.y1+b8;b6.y2=b6.y2+b8;b6.y3=b6.y3+b8;b6.z1=b6.z1+b9;b6.z2=b6.z2+b9;b6.z3=b6.z3+b9 end;return aO,b7,b8,b9 end;function a_.normalizeScale(aO)local ba=-math.huge;for az=1,#aO do local b6=aO[az]ba=d(ba,b6.x1)ba=d(ba,b6.x2)ba=d(ba,b6.x3)ba=d(ba,b6.y1)ba=d(ba,b6.y2)ba=d(ba,b6.y3)ba=d(ba,b6.z1)ba=d(ba,b6.z2)ba=d(ba,b6.z3)end;for az=1,#aO do local b6=aO[az]b6.x1=b6.x1/ba;b6.x2=b6.x2/ba;b6.x3=b6.x3/ba;b6.y1=b6.y1/ba;b6.y2=b6.y2/ba;b6.y3=b6.y3/ba;b6.z1=b6.z1/ba;b6.z2=b6.z2/ba;b6.z3=b6.z3/ba end;return aO end;function a_.normalizeScaleY(aO)local ba=-math.huge;for az=1,#aO do local b6=aO[az]ba=d(ba,b6.y1)ba=d(ba,b6.y2)ba=d(ba,b6.y3)end;for az=1,#aO do local b6=aO[az]b6.x1=b6.x1/ba;b6.x2=b6.x2/ba;b6.x3=b6.x3/ba;b6.y1=b6.y1/ba;b6.y2=b6.y2/ba;b6.y3=b6.y3/ba;b6.z1=b6.z1/ba;b6.z2=b6.z2/ba;b6.z3=b6.z3/ba end;return aO end;function a_.scale(aO,bb)for az=1,#aO do local b6=aO[az]b6.x1=b6.x1*bb;b6.x2=b6.x2*bb;b6.x3=b6.x3*bb;b6.y1=b6.y1*bb;b6.y2=b6.y2*bb;b6.y3=b6.y3*bb;b6.z1=b6.z1*bb;b6.z2=b6.z2*bb;b6.z3=b6.z3*bb end;return aO end;function a_.translate(aO,I,J,bc)for az=1,#aO do local b6=aO[az]b6.x1=b6.x1+(I or 0)b6.x2=b6.x2+(I or 0)b6.x3=b6.x3+(I or 0)b6.y1=b6.y1+(J or 0)b6.y2=b6.y2+(J or 0)b6.y3=b6.y3+(J or 0)b6.z1=b6.z1+(bc or 0)b6.z2=b6.z2+(bc or 0)b6.z3=b6.z3+(bc or 0)end;return aO end;function a_.rotate(aO,aP,aQ,aR)local aS,aT=0,1;local aU,aV=0,1;local aW,aX=0,1;if aP==0 then aP=nil end;if aP then aS,aT=aF(aP),aG(aP)end;if aQ==0 then aQ=nil end;if aQ then aU,aV=aF(aQ),aG(aQ)end;if aR==0 then aR=nil end;if aR then aW,aX=aF(aR),aG(aR)end;for az=1,#aO do local aA=aO[az]local B,C,a5=aA.x1,aA.y1,aA.z1;local D,E,a6=aA.x2,aA.y2,aA.z2;local R,S,a7=aA.x3,aA.y3,aA.z3;if aQ then B,C,a5=aL(B,C,a5,aU,aV)D,E,a6=aL(D,E,a6,aU,aV)R,S,a7=aL(R,S,a7,aU,aV)end;if aR then B,C=aM(B,C,a5,aW,aX)D,E=aM(D,E,a6,aW,aX)R,S=aM(R,S,a7,aW,aX)end;if aP then B,C,a5=aH(B,C,a5,aS,aT)D,E,a6=aH(D,E,a6,aS,aT)R,S,a7=aH(R,S,a7,aS,aT)end;aA.x1,aA.y1,aA.z1=B,C,a5;aA.x2,aA.y2,aA.z2=D,E,a6;aA.x3,aA.y3,aA.z3=R,S,a7 end;return aO end;function a_.alignBottom(aO)local V=math.huge;for az=1,#aO do local b6=aO[az]V=c(V,b6.y1)V=c(V,b6.y2)V=c(V,b6.y3)end;for az=1,#aO do local b6=aO[az]b6.y1=b6.y1-V;b6.y2=b6.y2-V;b6.y3=b6.y3-V end;return aO end;function a_.decimate(aO,bd,be)local bf={}local bg={}local function bh(h,i,aI)for az=#bf,1,-1 do local bi=bf[az]if bi[1]==h and bi[2]==i and bi[3]==aI then return az end end end;for az=1,#aO do local b6=aO[az]local bj=bh(b6.x1,b6.y1,b6.z1)if not bj then bf[#bf+1]={b6.x1,b6.y1,b6.z1}bj=#bf end;local bk=bh(b6.x2,b6.y2,b6.z2)if not bk then bf[#bf+1]={b6.x2,b6.y2,b6.z2}bk=#bf end;local bl=bh(b6.x3,b6.y3,b6.z3)if not bl then bf[#bf+1]={b6.x3,b6.y3,b6.z3}bl=#bf end;local b0={bj,bk,bl,b6.c,b6.forceRender}bg[#bg+1]=b0 end;local function bm(bn,bo)local I=bn[1]-bo[1]local J=bn[2]-bo[2]local bc=bn[3]-bo[3]return(I*I+J*J+bc*bc)^0.5 end;local bp={}for az=1,#bg do local b0=bg[az]local bq=bm(bf[b0[1]],bf[b0[2]])local br=bm(bf[b0[2]],bf[b0[3]])local bs=bm(bf[b0[1]],bf[b0[3]])bp[#bp+1]={length=bq,vA=b0[1],vB=b0[2]}bp[#bp+1]={length=br,vA=b0[2],vB=b0[3]}bp[#bp+1]={length=bs,vA=b0[1],vB=b0[3]}end;local function bt(bu,bv)local bw=bf[bu]local bx=bf[bv]local by={(bw[1]+bx[1])*0.5,(bw[2]+bx[2])*0.5,(bw[3]+bx[3])*0.5}bf[#bf+1]=by;local bz=#bf;for az=#bg,1,-1 do local bA=bg[az]if bA[1]==bu or bA[1]==bv or bA[2]==bu or bA[2]==bv or bA[3]==bu or bA[3]==bv then if bA[1]==bu or bA[1]==bv then bA[1]=bz end;if bA[2]==bu or bA[2]==bv then bA[2]=bz end;if bA[3]==bu or bA[3]==bv then bA[3]=bz end;if bA[1]==bA[2]or bA[2]==bA[3]or bA[1]==bA[3]then table.remove(bg,az)end end end;return bz end;local bB=bd;if be~="polys"then bB=#aO*bd end;while#bg>bB do local bC=math.huge;local bD;for az=1,#bp do local bE=bp[az]if bE.length<bC then bC=bE.length;bD=az end end;local bF=bp[bD]local bz=bt(bF.vA,bF.vB)for az=#bp,1,-1 do local bE=bp[az]local bG=bE.vA==bF.vA or bE.vA==bF.vB;local bH=bE.vB==bF.vA or bE.vB==bF.vB;if bG and bH then table.remove(bp,az)elseif bG then bE.vA=bz elseif bH then bE.vB=bz end end end;local bI={}for az=1,#bg do local b0=bg[az]local bn=bf[b0[1]]local bo=bf[b0[2]]local bJ=bf[b0[3]]bI[#bI+1]={x1=bn[1],y1=bn[2],z1=bn[3],x2=bo[1],y2=bo[2],z2=bo[3],x3=bJ[1],y3=bJ[2],z3=bJ[3],c=b0[4],forceRender=b0[5]}end;for bK,bL in pairs(a_)do bI[bK]=bL end;return bI end;local bM,bN;function a_.toLoD(aO,bO)bO=bO or{}local bP={minQuality=bO.minQuality or 0.1,variantCount=bO.variantCount or 4,qualityHalvingDistance=bO.qualityHalvingDistance or 5,quickInitWorseRuntime=bO.quickInitWorseRuntime or false}local bQ,bR=bN(aO)local bS={{quality=1,collapsedModel=bQ,size=bR}}local bT=aO;local bU=#bT;for az=1,bP.variantCount do local bd=(1-bP.minQuality)*(1-az/bP.variantCount)+bP.minQuality;local bV=math.floor(bU*bd+0.5)local bW=bT:decimate(bV,"polys")local bQ,bR=bN(bW)bT=bW;local bX={quality=bd,collapsedModel=bQ,size=bR}bS[#bS+1]=bX end;local function bY(bZ)local b_={}for az=1,#bZ do local bX=bZ[az]local aO=bX.collapsedModel;local c0={}for c1=1,#aO do local b6=aO[c1]local c2={b6[1],b6[2],b6[3],b6[4],b6[5],b6[6],b6[7],b6[8],b6[9],b6[10],b6[11],b6[12]}c0[c1]=c2 end;local c3={quality=bX.quality,size=bX.size,collapsedModel=c0}b_[az]=c3 end;return b_ end;local c4={}function bP:initObject(c5)local c6;if bP.quickInitWorseRuntime then c6=bS else c6=bY(bS)end;c4[c5]=c6;c5[7]=c6[1].collapsedModel;c5[8]=c6[1].size;c5[9]=bP end;function bP:update(c5,as)local c6=c4[c5]if c6 then local I=as[1]-c5[1]local J=as[2]-c5[2]local bc=as[3]-c5[3]local a4=(I*I+J*J+bc*bc)^0.5;local c7=math.min(1,math.max(bP.minQuality,1/(a4/bP.qualityHalvingDistance)))local c8=bP.variantCount+1-bP.variantCount*(c7-bP.minQuality)/(1-bP.minQuality)local c9=math.floor(c8+0.5)local bX=c6[c9]c5[7]=bX.collapsedModel;c5[8]=bX.size end end;return bP end;local ca=math.sqrt;function bN(aO)local cb={}local cc=0;for az=1,#aO do local aA=aO[az]cb[#cb+1]={}cb[#cb][1]=aA.x1;cb[#cb][2]=aA.y1;cb[#cb][3]=aA.z1;cb[#cb][4]=aA.x2;cb[#cb][5]=aA.y2;cb[#cb][6]=aA.z2;cb[#cb][7]=aA.x3;cb[#cb][8]=aA.y3;cb[#cb][9]=aA.z3;cb[#cb][10]=aA.forceRender;cb[#cb][11]=aA.c;cb[#cb][12]=aA.outlineColor;local cd=ca(aA.x1*aA.x1+aA.y1*aA.y1+aA.z1*aA.z1)local ce=ca(aA.x2*aA.x2+aA.y2*aA.y2+aA.z2*aA.z2)local cf=ca(aA.x3*aA.x3+aA.y3*aA.y3+aA.z3*aA.z3)if cd>cc then cc=cd end;if ce>cc then cc=ce end;if cf>cc then cc=cf end end;return cb,cc end;function bM(cg)local ch=fs.open(cg,"r")if not ch then error("Could not find model for an object at path: "..cg)end;local ci=ch.readAll()ch.close()if not ci then error("Failed to parse model for an object at path: "..cg)end;local aO=textutils.unserialise(ci)for bK,bL in pairs(a_)do aO[bK]=bL end;return aO end;local cj=math.pi;local aF=math.sin;local aG=math.cos;local ck=math.tan;local ca=math.sqrt;local function cl(h,i,j,k)local cm,cn=term.getSize()h=h or 1;i=i or 1;j=j or cm;k=k or cn;local co={camera={0,0,0,nil,0,0},buffer=g(h,i,j,k),width=j*2,height=k*3}co.FoV=90;co.camera[7]=aE(co.FoV)co.camera[8]=2*math.atan(math.tan(aE(co.FoV)*0.5)/(co.width/co.height/1.5))co.t=ck(aE(co.FoV/2))*2*0.0001;local cp,cq,cr,cs;function co:setBackgroundColor(t)local ct=self.buffer;ct.backgroundColor=t;ct:fastClear()end;local function cu()cp=e(co.width*0.5)+1;cq=e(co.height*0.5)cr=0.0001*co.width/co.t;cs=-0.0001*co.width/(co.t*co.height)*co.height end;cu()function co:setSize(h,i,j,k)self.width=j*2;self.height=k*3;self.buffer:setSize(h,i,j,k)cu()end;function co:depthInterpolation(am)self.interpolateDepth=am;self.buffer:depthInterpolation(am)end;function co:map3dTo2d(h,i,aI)local as=self.camera;local cv=aF(as[4]or 0)local cw=aG(as[4]or 0)local cx=aF(-as[5])local cy=aG(-as[5])local cz=aF(as[6])local cA=aG(as[6])local cB=h-as[1]local cC=i-as[2]local cD=aI-as[3]local cE=cy*cB-cx*cD;cD=cx*cB+cy*cD;cB=cE;local cF=cA*cC-cz*cB;cB=cz*cC+cA*cB;cC=cF;if cv~=0 then local cG=cv*cD-cw*cC;cC=cw*cD+cv*cC;cD=cG end;local cH=cD/cB*cr+cp;local cI=cC/cB*cs+cq;return cH,cI,cB>=0.0001 end;function co:drawObject(c5,as,cJ)local cK=c5[1]local cL=c5[2]local cM=c5[3]local cv=cJ[1]local cw=cJ[2]local cx=cJ[3]local cy=cJ[4]local cz=cJ[5]local cA=cJ[6]local cN=cK and cK-as[1]or 0;local cO=cL and cL-as[2]or 0;local cP=cM and cM-as[3]or 0;local bP=c5[9]if bP then bP:update(c5,as)end;local aO=c5[7]if#aO<=0 then return true end;local bR=c5[8]local cB=cN;local cC=cO;local cD=cP;local cE=cy*cB-cx*cD;local cD=cx*cB+cy*cD;local cB=cE;local cF=cA*cC-cz*cB;local cB=cz*cC+cA*cB;cC=cF;if cB<-bR then return true end;local cQ=0.5*as[7]local cR=aF(cQ)local cS=aG(cQ)if(cB+bR)*cR+(cD+bR)*cS<0 then return true end;if(cB+bR)*cR-(cD-bR)*cS<0 then return true end;local cT=0.5*as[8]local cR=aF(cT)local cU=aG(cT)if(cB+bR)*cR+(cC+bR)*cU<0 then return true end;if(cB+bR)*cR-(cC-bR)*cU<0 then return true end;local aP=c5[4]local aQ=c5[5]local aR=c5[6]if aP and aP~=0 or aQ and aQ~=0 or aR and aR~=0 then aO=aN(aO,aP,aQ,aR)end;an(aO,cK,cL,cM,as)local cV=cN*cN+cO*cO+cP*cP<bR*bR*4;local cp=cp;local cq=cq;local cr=cr;local cs=cs;local cv=cv;local cw=cw;local cx=cx;local cy=cy;local cz=cz;local cA=cA;local cN=cN;local cO=cO;local cP=cP;local function cW(cB,cC,cD)local cE=cy*cB-cx*cD;cD=cx*cB+cy*cD;cB=cE;local cF=cA*cC-cz*cB;cB=cz*cC+cA*cB;cC=cF;local cH=cD/cB*cr+cp;local cI=cC/cB*cs+cq;return cH,cI,cB end;if cv~=0 then function cW(cB,cC,cD)local cE=cy*cB-cx*cD;cD=cx*cB+cy*cD;cB=cE;local cF=cA*cC-cz*cB;cB=cz*cC+cA*cB;cC=cF;local cG=cv*cD-cw*cC;cC=cw*cD+cv*cC;cD=cG;local cH=cD/cB*cr+cp;local cI=cC/cB*cs+cq;return cH,cI,cB end end;local cX=aO;local ct=self.buffer;for az=1,#cX do local aA=cX[az]local U=aA[16]local B,C,cY=cW(aA[1]+cN,aA[2]+cO,aA[3]+cP)if cY>0.00010000001 then local D,E,cE=cW(aA[4]+cN,aA[5]+cO,aA[6]+cP)if cE>0.00010000001 then local R,S,cZ=cW(aA[7]+cN,aA[8]+cO,aA[9]+cP)if cZ>0.00010000001 then if aA[10]or(D-B)*(S-E)-(E-C)*(R-D)<0 then ct:drawTriangle(B,C,D,E,R,S,aA[11],aA[12],U,cY,cE,cZ)end elseif cV then local function c_(h,i,aI)local cB=h+cN;local cC=i+cO;local cD=aI+cP;local cE=cy*cB-cx*cD;cD=cx*cB+cy*cD;cB=cE;local cF=cA*cC-cz*cB;cB=cz*cC+cA*cB;cC=cF;if cv~=0 then local cG=cv*cD-cw*cC;cC=cw*cD+cv*cC;cD=cG end;local cH=cD/cB*cr+cp;local cI=cC/cB*cs+cq;return cH,cI,cB,cC,cD end;local B,C,cY,d0,d1=c_(aA[1],aA[2],aA[3])local D,E,cE,cF,cG=c_(aA[4],aA[5],aA[6])local R,S,cZ,d2,d3=c_(aA[7],aA[8],aA[9])local d4=math.abs;local d5=d4(cZ-0.0001)local d6=d4(cY-0.0001)local d7=d6+d5;local d8=(d3*d6+d1*d5)/d7;local d9=(d2*d6+d0*d5)/d7;local cp,cr,cq,cs=cp,cr,cq,cs;local da=d8*10000*cr+cp;local db=d9*10000*cs+cq;if aA[10]or(D-B)*(db-E)-(E-C)*(da-D)<0 then ct:drawTriangle(B,C,D,E,da,db,aA[11],aA[12],U,cY,cE,0.0001)local dc=d4(cE-0.0001)local d7=dc+d5;local d8=(cG*d5+d3*dc)/d7;local d9=(cF*d5+d2*dc)/d7;local dd=d8*10000*cr+cp;local de=d9*10000*cs+cq;ct:drawTriangle(dd,de,D,E,da,db,aA[11],aA[12],U,0.0001,cE,0.0001)end end elseif cV then local function c_(h,i,aI)local cB=h+cN;local cC=i+cO;local cD=aI+cP;local cE=cy*cB-cx*cD;cD=cx*cB+cy*cD;cB=cE;local cF=cA*cC-cz*cB;cB=cz*cC+cA*cB;cC=cF;if cv~=0 then local cG=cv*cD-cw*cC;cC=cw*cD+cv*cC;cD=cG end;local cH=cD/cB*cr+cp;local cI=cC/cB*cs+cq;return cH,cI,cB,cC,cD end;local B,C,cY,d0,d1=c_(aA[1],aA[2],aA[3])local D,E,cE,cF,cG=c_(aA[4],aA[5],aA[6])local R,S,cZ,d2,d3=c_(aA[7],aA[8],aA[9])local d4=math.abs;if cZ>0.00010000001 then local dc=d4(cE-0.0001)local d6=d4(cY-0.0001)local d7=d6+dc;local d8=(cG*d6+d1*dc)/d7;local d9=(cF*d6+d0*dc)/d7;local cp,cr,cq,cs=cp,cr,cq,cs;local da=d8*10000*cr+cp;local db=d9*10000*cs+cq;if aA[10]or(da-B)*(S-db)-(db-C)*(R-da)<0 then ct:drawTriangle(B,C,da,db,R,S,aA[11],aA[12],U,cY,0.0001,cZ)local d5=d4(cZ-0.0001)local d7=dc+d5;local d8=(cG*d5+d3*dc)/d7;local d9=(cF*d5+d2*dc)/d7;local dd=d8*10000*cr+cp;local de=d9*10000*cs+cq;ct:drawTriangle(dd,de,da,db,R,S,aA[11],aA[12],U,0.0001,0.0001,cZ)end else local d6=d4(cY-0.0001)local dc=d4(cE-0.0001)local d5=d4(cZ-0.0001)local df=d6+dc;local dg=d6+d5;local d8=(d1*dc+cG*d6)/df;local d9=(d0*dc+cF*d6)/df;local cp,cr,cq,cs=cp,cr,cq,cs;local da=d8*10000*cr+cp;local db=d9*10000*cs+cq;local dh=(d1*d5+d3*d6)/dg;local di=(d0*d5+d2*d6)/dg;local dd=dh*10000*cr+cp;local de=di*10000*cs+cq;if aA[10]or(da-B)*(de-db)-(db-C)*(dd-da)<0 then ct:drawTriangle(B,C,da,db,dd,de,aA[11],aA[12],U,cY,0.0001,0.0001)end end end elseif cV then local function c_(h,i,aI)local cB=h+cN;local cC=i+cO;local cD=aI+cP;local cE=cy*cB-cx*cD;cD=cx*cB+cy*cD;cB=cE;local cF=cA*cC-cz*cB;cB=cz*cC+cA*cB;cC=cF;if cv~=0 then local cG=cv*cD-cw*cC;cC=cw*cD+cv*cC;cD=cG end;local cH=cD/cB*cr+cp;local cI=cC/cB*cs+cq;return cH,cI,cB,cC,cD end;local B,C,cY,d0,d1=c_(aA[1],aA[2],aA[3])local D,E,cE,cF,cG=c_(aA[4],aA[5],aA[6])local R,S,cZ,d2,d3=c_(aA[7],aA[8],aA[9])local d4=math.abs;if cE>0.00010000001 then if cZ>0.00010000001 then local d6=d4(cY-0.0001)local dc=d4(cE-0.0001)local d7=d6+dc;local d8=(d1*dc+cG*d6)/d7;local d9=(d0*dc+cF*d6)/d7;local cp,cr,cq,cs=cp,cr,cq,cs;local da=d8*10000*cr+cp;local db=d9*10000*cs+cq;if aA[10]or(D-da)*(S-E)-(E-db)*(R-D)<0 then ct:drawTriangle(da,db,D,E,R,S,aA[11],aA[12],U,0.0001,cE,cZ)local d5=d4(cZ-0.0001)local d7=d6+d5;local d8=(d1*d5+d3*d6)/d7;local d9=(d0*d5+d2*d6)/d7;local dd=d8*10000*cr+cp;local de=d9*10000*cs+cq;ct:drawTriangle(da,db,dd,de,R,S,aA[11],aA[12],U,0.0001,0.0001,cZ)end else local d6=d4(cY-0.0001)local dc=d4(cE-0.0001)local d5=d4(cZ-0.0001)local df=dc+d6;local dg=dc+d5;local d8=(d1*dc+cG*d6)/df;local d9=(d0*dc+cF*d6)/df;local cp,cr,cq,cs=cp,cr,cq,cs;local da=d8*10000*cr+cp;local db=d9*10000*cs+cq;local dh=(cG*d5+d3*dc)/dg;local di=(cF*d5+d2*dc)/dg;local dd=dh*10000*cr+cp;local de=di*10000*cs+cq;if aA[10]or(D-da)*(de-E)-(E-db)*(dd-D)<0 then ct:drawTriangle(da,db,D,E,dd,de,aA[11],aA[12],U,0.0001,cE,0.0001)end end else if cZ>0.00010000001 then local d6=d4(cY-0.0001)local dc=d4(cE-0.0001)local d5=d4(cZ-0.0001)local df=d5+d6;local dg=d5+dc;local d8=(d1*d5+d3*d6)/df;local d9=(d0*d5+d2*d6)/df;local cp,cr,cq,cs=cp,cr,cq,cs;local da=d8*10000*cr+cp;local db=d9*10000*cs+cq;local dh=(cG*d5+d3*dc)/dg;local di=(cF*d5+d2*dc)/dg;local dd=dh*10000*cr+cp;local de=di*10000*cs+cq;if aA[10]or(dd-da)*(S-de)-(de-db)*(R-dd)<0 then ct:drawTriangle(da,db,dd,de,R,S,aA[11],aA[12],U,0.0001,0.0001,cZ)end end end end end end;function co:drawObjects(dj)self.buffer:clearDepth()local as=self.camera;local cJ={aF(as[4]or 0),aG(as[4]or 0),aF(-as[5]),aG(-as[5]),aF(as[6]),aG(as[6])}local dk=0;local dj=dj;for az=1,#dj do local dl=self:drawObject(dj[az],as,cJ)if dl then dk=dk+1 end end;return dk end;function co:drawBuffer()local ct=self.buffer;ct:drawBuffer()ct:fastClear()end;function co:setCamera(dm,dn,dp,aP,aQ,aR)local aE=math.rad;if type(dm)=="table"then local as=dm;self.camera={as.x or self.camera[1]or 0,as.y or self.camera[2]or 0,as.z or self.camera[3]or 0,as.rotX and aE(as.rotX+90)or self.camera[4]or 0,as.rotY and aE(as.rotY)or self.camera[5]or 0,as.rotZ and aE(as.rotZ)or self.camera[6]or 0,self.camera[7],self.camera[8]}else self.camera={dm or self.camera[1]or 0,dn or self.camera[2]or 0,dp or self.camera[3]or 0,aP and aE(aP+90)or self.camera[4]or 0,aQ and aE(aQ)or self.camera[5]or 0,aR and aE(aR)or self.camera[6]or 0,self.camera[7],self.camera[8]}end;if self.camera[4]==math.pi*0.5 then self.camera[4]=nil end end;function co:setFoV(cQ)self.FoV=cQ or 90;self.t=ck(aE(self.FoV/2))*2*0.0001;cu()self.camera[7]=aE(self.FoV)self.camera[8]=2*math.atan(math.tan(aE(self.FoV)*0.5)/(self.width/self.height/1.5))end;function co:setWireFrame(am)self.buffer:useTriangleEdges(am)end;function co:getObjectIndexTrace(dj,h,i)local function dq(B,C,D,E,R,S)return(B-R)*(E-S)-(D-R)*(C-S)end;local function dr(ds,dt,B,C,D,E,R,S,du,dv,dw,dx)local dy=dq(ds,dt,B,C,D,E)<0;local dz=dq(ds,dt,D,E,R,S)<0;local dA=dq(ds,dt,R,S,B,C)<0;return dy==dz and dz==dA end;local i=i-1;local dB=1;local dC=1;local dD=self.height;local dE=self.width;h=h*2;i=i*3+1;local as=self.camera;local cJ={aF(as[4]or 0),aG(as[4]or 0),aF(-as[5]),aG(-as[5]),aF(as[6]),aG(as[6])}local cv=cJ[1]local cw=cJ[2]local cx=cJ[3]local cy=cJ[4]local cz=cJ[5]local cA=cJ[6]local dF={}for az=1,#dj do local c5=dj[az]local aO=c5[7]local aP=c5[4]local aQ=c5[5]local aR=c5[6]if aP and aP~=0 or aQ and aQ~=0 or aR and aR~=0 then aO=aN(aO,aP,aQ,aR)end;local cK=c5[1]local cL=c5[2]local cM=c5[3]an(aO,cK,cL,cM,as)local cp=cp;local cq=cq;local cr=cr;local cs=cs;local cv=cv;local cw=cw;local cx=cx;local cy=cy;local cz=cz;local cA=cA;local cN=cK-as[1]local cO=cL-as[2]local cP=cM-as[3]local function cW(h,i,aI)local cB=h+cN;local cC=i+cO;local cD=aI+cP;local cE=cy*cB-cx*cD;cD=cx*cB+cy*cD;cB=cE;local cF=cA*cC-cz*cB;cB=cz*cC+cA*cB;cC=cF;if cv~=0 then local cG=cv*cD-cw*cC;cC=cw*cD+cv*cC;cD=cG end;local cH=cD/cB*cr+cp;local cI=cC/cB*cs+cq;return cH,cI,cB>0 end;for c1=1,#aO do local aA=aO[c1]local B,C,dG=cW(aA[1],aA[2],aA[3])if dG then local D,E,dH=cW(aA[4],aA[5],aA[6])if dH then local R,S,dI=cW(aA[7],aA[8],aA[9])if dI then if aA[10]or(D-B)*(S-E)-(E-C)*(R-D)<0 then local aB=cN+(aA[1]+aA[4]+aA[7])/3;local aC=cO+(aA[2]+aA[5]+aA[8])/3;local aD=cP+(aA[3]+aA[6]+aA[9])/3;local U=aB*aB+aC*aC+aD*aD;if dr(h,i,B,C,D,E,R,S,(dE-1)*2+1,(dC-1)*3+1,dE*2,(dD+1)*3)then dF[#dF+1]={objectIndex=az,polygonIndex=c1,depth=U}end end end end end end end;if#dF<=0 then return elseif#dF==1 then return dF[1].objectIndex,dF[1].polygonIndex,dF[1].depth end;local dJ=-1;local dK=math.huge;for az=1,#dF do local dL=dF[az]if dL.depth<dK then dK=dL.depth;dJ=az end end;local dL=dF[dJ]return dL.objectIndex,dL.polygonIndex,dL.depth end;function co:newObject(aO,h,i,aI,aP,aQ,aR)local bQ=nil;local bR=nil;if type(aO)=="table"then if aO.initObject then else bQ,bR=bN(aO)end else local dM=bM(aO)bQ,bR=bN(dM)end;local c5={h,i,aI,aP,aQ,aR,bQ,bR}c5.frame=self;function c5:setPos(dN,dO,dP)self[1]=dN or self[1]self[2]=dO or self[2]self[3]=dP or self[3]end;function c5:setRot(dQ,dR,dS)self[4]=dQ or self[4]self[5]=dR or self[5]self[6]=dS or self[6]end;function c5:setModel(dT)if type(dT)=="table"then bQ,bR=bN(dT)self[7]=bQ;self[8]=bR else local dM=bM(dT)bQ,bR=bN(dM)self[7]=bQ;self[8]=bR end end;if type(aO)=="table"then if aO.initObject then aO:initObject(c5)end end;return c5 end;co:depthInterpolation(true)return co end;local dU={}local function dV(B,C,a5,D,E,a6,R,S,a7,t)local b6={x1=B,y1=C,z1=a5,x2=D,y2=E,z2=a6,x3=R,y3=S,z3=a7,c=t}return b6 end;function dU:cube(dW)dW.color=dW.color or colors.red;local dX={dV(-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,.5,dW.bottom or dW.color),dV(-.5,-.5,-.5,.5,-.5,-.5,.5,-.5,.5,dW.bottom2 or dW.bottom or dW.color),dV(-.5,.5,-.5,-.5,.5,.5,.5,.5,.5,dW.top or dW.color),dV(-.5,.5,-.5,.5,.5,.5,.5,.5,-.5,dW.top or dW.color),dV(-.5,-.5,-.5,-.5,-.5,.5,-.5,.5,-.5,dW.side or dW.color),dV(-.5,-.5,.5,-.5,.5,.5,-.5,.5,-.5,dW.side2 or dW.side or dW.color),dV(.5,-.5,-.5,.5,.5,.5,.5,-.5,.5,dW.side or dW.color),dV(.5,-.5,-.5,.5,.5,-.5,.5,.5,.5,dW.side2 or dW.side or dW.color),dV(-.5,-.5,-.5,.5,.5,-.5,.5,-.5,-.5,dW.side or dW.color),dV(-.5,-.5,-.5,-.5,.5,-.5,.5,.5,-.5,dW.side2 or dW.side or dW.color),dV(-.5,-.5,.5,.5,-.5,.5,-.5,.5,.5,dW.side or dW.color),dV(.5,-.5,.5,.5,.5,.5,-.5,.5,.5,dW.side2 or dW.side or dW.color)}for bK,bL in pairs(a_)do dX[bK]=bL end;return dX end;function dU:sphere(dW)dW.res=dW.res or 32;dW.color=dW.color or colors.red;local aO={}local dY={}for az=0,dW.res do local i=0.5*aG(az/dW.res*cj)local dZ={}for c1=0,dW.res do local d_=0.5*ca(1-i*2*i*2)local h=aG(c1/dW.res*cj*2)*d_;local aI=aF(c1/dW.res*cj*2)*d_;local D=aG((c1+1)/dW.res*cj*2)*d_;local a6=aF((c1+1)/dW.res*cj*2)*d_;if dY[c1]then aO[#aO+1]={x1=dY[(c1+1)%dW.res].x,y1=dY[(c1+1)%dW.res].y,z1=dY[(c1+1)%dW.res].z,x2=h,y2=i,z2=aI,x3=dY[c1].x,y3=dY[c1].y,z3=dY[c1].z,c=dW.color}aO[#aO+1]={x1=D,y1=i,z1=a6,x2=h,y2=i,z2=aI,x3=dY[(c1+1)%dW.res].x,y3=dY[(c1+1)%dW.res].y,z3=dY[(c1+1)%dW.res].z,c=dW.color2 or dW.color}end;dZ[c1]={x=h,y=i,z=aI}end;dY=dZ end;if dW.colors or dW.top or dW.bottom then for az=1,#aO do local b6=aO[az]local aC=(b6.y1+b6.y2+b6.y3)/3;if dW.colors then local e0=e((-aC+0.5)*#dW.colors+1)b6.c=dW.colors[e0]or b6.c else if aC>=0 then b6.c=dW.top or b6.c else b6.c=dW.bottom or b6.c end end end end;for bK,bL in pairs(a_)do aO[bK]=bL end;return aO end;function dU:icosphere(dW)dW.res=dW.res or 1;local e1=(1+ca(5))/2;local e2={{e1,1,0},{e1,-1,0},{-e1,-1,0},{-e1,1,0},{1,0,e1},{-1,0,e1},{-1,0,-e1},{1,0,-e1},{0,e1,1},{0,e1,-1},{0,-e1,-1},{0,-e1,1}}local function e3(bj,bk,bl)return dV(e2[bj][1],e2[bj][2],e2[bj][3],e2[bk][1],e2[bk][2],e2[bk][3],e2[bl][1],e2[bl][2],e2[bl][3],dW.colors and 1 or dW.color)end;local aO={e3(11,2,12),e3(11,8,2),e3(11,7,8),e3(11,3,7),e3(11,12,3),e3(4,7,3),e3(4,10,7),e3(4,9,10),e3(4,6,9),e3(4,3,6),e3(5,6,12),e3(5,9,6),e3(5,1,9),e3(5,2,1),e3(5,12,2),e3(3,12,6),e3(1,8,10),e3(1,10,9),e3(1,2,8),e3(10,8,7)}local function e4()local bI={}for az=1,#aO do local b6=aO[az]local e5={x=(b6.x1+b6.x2)/2,y=(b6.y1+b6.y2)/2,z=(b6.z1+b6.z2)/2}local e6={x=(b6.x1+b6.x3)/2,y=(b6.y1+b6.y3)/2,z=(b6.z1+b6.z3)/2}local e7={x=(b6.x2+b6.x3)/2,y=(b6.y2+b6.y3)/2,z=(b6.z2+b6.z3)/2}local e8=b6.c;if dW.colorsFractal then e8=e8%#dW.colors+1 end;bI[#bI+1]=dV(e5.x,e5.y,e5.z,e7.x,e7.y,e7.z,e6.x,e6.y,e6.z,b6.c)bI[#bI+1]=dV(b6.x1,b6.y1,b6.z1,e5.x,e5.y,e5.z,e6.x,e6.y,e6.z,e8)bI[#bI+1]=dV(e5.x,e5.y,e5.z,b6.x2,b6.y2,b6.z2,e7.x,e7.y,e7.z,e8)bI[#bI+1]=dV(e6.x,e6.y,e6.z,e7.x,e7.y,e7.z,b6.x3,b6.y3,b6.z3,e8)end;aO=bI end;for az=1,dW.res-1 do e4()end;local function e9(h,i,aI)local ea=math.sqrt(h*h+i*i+aI*aI)local eb=0.5/ea;return h*eb,i*eb,aI*eb end;for az=1,#aO do local b6=aO[az]b6.x1,b6.y1,b6.z1=e9(b6.x1,b6.y1,b6.z1)b6.x2,b6.y2,b6.z2=e9(b6.x2,b6.y2,b6.z2)b6.x3,b6.y3,b6.z3=e9(b6.x3,b6.y3,b6.z3)if not dW.colorsFractal then local aC=(b6.y1+b6.y2+b6.y3)/3;if dW.colors then local e0=math.floor((-aC+0.5)*#dW.colors+1)b6.c=dW.colors[e0]or b6.c else if aC>=0 then b6.c=dW.top or b6.c else b6.c=dW.bottom or b6.c end end else b6.c=dW.colors[b6.c]end end;for bK,bL in pairs(a_)do aO[bK]=bL end;return aO end;function dU:plane(dW)dW.color=dW.color or colors.lime;dW.size=dW.size or 1;dW.y=dW.y or 0;local ec={dV(-1*dW.size,dW.y,1*dW.size,1*dW.size,dW.y,-1*dW.size,-1*dW.size,dW.y,-1*dW.size,dW.color),dV(-1*dW.size,dW.y,1*dW.size,1*dW.size,dW.y,1*dW.size,1*dW.size,dW.y,-1*dW.size,dW.color)}for bK,bL in pairs(a_)do ec[bK]=bL end;return ec end;function dU:mountains(dW)dW.res=dW.res or 20;dW.randomOffset=dW.randomOffset or 0;dW.height=dW.height or 1;dW.randomHeight=dW.randomHeight or 0;dW.y=dW.y or 0;dW.scale=dW.scale or 100;dW.color=dW.color or colors.green;dW.snowColor=dW.snowColor or colors.white;local ed=3/dW.res*dW.height/(dW.randomHeight+1)local ee=3/dW.res*dW.height*(dW.randomHeight+1)local aO={}for az=0,dW.res do local ef=math.random(-dW.randomOffset*100,dW.randomOffset*100)/100;local eg=az+ef;local B=aG((eg-1)/dW.res*cj*2)*dW.scale;local a5=aF((eg-1)/dW.res*cj*2)*dW.scale;local D=aG((eg-0.5)/dW.res*cj*2)*dW.scale;local a6=aF((eg-0.5)/dW.res*cj*2)*dW.scale;local R=aG(eg/dW.res*cj*2)*dW.scale;local a7=aF(eg/dW.res*cj*2)*dW.scale;local eh=math.random(ed*100,ee*100)/100*dW.scale;local aA={x1=B,y1=dW.y,z1=a5,x2=R,y2=dW.y,z2=a7,x3=D,y3=dW.y+eh,z3=a6,c=dW.color,forceRender=true}aO[#aO+1]=aA;if dW.snow then local ei=0.93;local ej=dW.snowHeight or 0.5;local ek=1-ej*ee/(eh/dW.scale)ek=d(0,c(1,ek))if ek>0.2 then local el={x1=(B*ek+D*(1-ek))*ei,y1=dW.y+eh*(1-ek),z1=(a5*ek+a6*(1-ek))*ei,x2=(R*ek+D*(1-ek))*ei,y2=dW.y+eh*(1-ek),z2=(a7*ek+a6*(1-ek))*ei,x3=D*ei,y3=dW.y+eh,z3=a6*ei,c=dW.snowColor,forceRender=true}aO[#aO+1]=el end end end;for bK,bL in pairs(a_)do aO[bK]=bL end;return aO end;return{newFrame=cl,loadModel=bM,newBuffer=g,models=dU,transforms=a_}