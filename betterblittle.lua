local a=math.floor;local b=math.min;local c=table.concat;local d={}for e=1,16 do d[2^(e-1)]=e end;local f={}for e=1,16 do f[e]=("0123456789abcdef"):sub(e,e)end;local g;local function h(i,j,k,l,m,n)local o={0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}o[i]=1;o[j]=o[j]+1;o[k]=o[k]+1;o[l]=o[l]+1;o[m]=o[m]+1;o[n]=o[n]+1;local p=i;local q=i;local r=0;local s=0;for t=1,16 do local u=o[t]if u>0 then r=r+1;if t~=p then q=t end;if u>s then q=p;p=t;s=u end end end;if r<=2 then return p,q end;local v=i;local w=99;local x=g[p]for q=1,16 do if q~=p and o[q]>0 then local y=g[q]local z=b(x[i],y[i])+b(x[j],y[j])+b(x[k],y[k])+b(x[l],y[l])+b(x[m],y[m])+b(x[n],y[n])if z<w then w=z;v=q end end end;return p,v end;local function A(B,C,D)local function E(F)return F>=0.04045 and((F+0.055)/(1+0.055))^2.4 or F/12.92 end;B,C,D=E(B),E(C),E(D)local G=(0.4122214708*B+0.5363325363*C+0.0514459929*D)^(1/3)local H=(0.2119034982*B+0.6806995451*C+0.1073969566*D)^(1/3)local I=(0.0883024619*B+0.2817188376*C+0.6299787005*D)^(1/3)return 0.2104542553*G+0.7936177850*H-0.0040720468*I,1.9779984951*G-2.4285922050*H+0.4505937099*I,0.0259040371*G+0.7827717662*H-0.8086757660*I end;local function J(K,L)g={}for p=1,16 do local M,N,O=K.getPaletteColor(2^(p-1))if L~="sRGB"then M,N,O=A(M,N,O)end;local P={}for q=1,16 do local Q,R,S=K.getPaletteColor(2^(q-1))if L~="sRGB"then Q,R,S=A(Q,R,S)end;P[q]=(Q-M)^2+(R-N)^2+(S-O)^2 end;g[p]=P end end;local T=string.char;local U={}for e=1,32 do U[e]=T(e+127)end;local function V(i,j,k,l,m,n)local p,q=h(i,j,k,l,m,n)local W=g[p]local X=g[q]if W[n]<X[n]then local Y=(W[i]<X[i]and 31 or 32)-(W[j]<X[j]and 2 or 0)-(W[k]<X[k]and 4 or 0)-(W[l]<X[l]and 8 or 0)-(W[m]<X[m]and 16 or 0)return U[Y],q,p else local Y=(W[i]<X[i]and 2 or 1)+(W[j]<X[j]and 2 or 0)+(W[k]<X[k]and 4 or 0)+(W[l]<X[l]and 8 or 0)+(W[m]<X[m]and 16 or 0)return U[Y],p,q end end;local function Z(_,K,a0,a1)a0=a0 or 1;a1=a1 or 1;local a2=#_;local a3=#_[1]if not g then J(K)end;local a4=a(a3/2)local a5=K.setCursorPos;local a6=K.blit;local f=f;for a7=0,a(a2/3)-1 do local a8=a7*3+1;local M=_[a8]local Q=_[a8+1]local a9=_[a8+2]local aa={nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil}local ab={nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil}local ac={nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil}for ad=1,a4 do local ae=(ad-1)*2+1;local i=d[M[ae]]local j=d[M[ae+1]]local k=d[Q[ae]]local l=d[Q[ae+1]]local m=d[a9[ae]]local n=d[a9[ae+1]]if i==j and j==k and k==l and l==m and m==n then local af=f[i]aa[ad]=af;ab[ad]=af;ac[ad]="\x80"else local T,p,q=V(i,j,k,l,m,n)aa[ad]=f[p]ab[ad]=f[q]ac[ad]=T end end;local ag=c;local p=ag(ac)local q=ag(aa)local ah=ag(ab)a5(a0,a1+a7)a6(p,q,ah)end end;return{drawBuffer=Z,recomputeColorDistances=J}